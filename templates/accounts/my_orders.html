{% extends 'base.html' %}
{% load humanize %} {# Django's humanize library for better date formatting #}

{% block title %}My Orders - {{ block.super }}{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-xl p-6 md:p-8">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between border-b pb-4 mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">My Order History</h1>
            <p class="text-sm text-gray-500 mt-1">Here you can find all your past and current orders.</p>
        </div>
        
        <!-- Clear History Button/Form -->
        {% if orders %} {# Only show button if there are any orders to clear #}
        <form action="{% url 'clear_completed_orders' %}" method="POST" onsubmit="return confirm('Are you sure you want to permanently delete your completed order history? This action cannot be undone.');">
            {% csrf_token %}
            <button type="submit" class="mt-2 md:mt-0 flex items-center bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-300 text-sm font-semibold">
                <i class="fas fa-trash-alt mr-2"></i>
                Clear Completed
            </button>
        </form>
        {% endif %}
    </div>

    {% if orders %}
    <div class="space-y-6">
        {% for order in orders %}
        <div class="bg-gray-50 rounded-lg shadow-sm border p-4 transition-shadow hover:shadow-md">
            <!-- Order Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-3">
                <div>
                    <h2 class="text-lg font-bold text-gray-900">Order #{{ order.id }}</h2>
                    <p class="text-sm text-gray-500">Placed on: {{ order.order_date|date:"F d, Y, h:i A" }}</p>
                </div>
                <div class="mt-2 md:mt-0">
                    <span class="px-3 py-1 text-sm font-semibold rounded-full 
                        {% if order.is_completed %} bg-green-100 text-green-800 {% else %} bg-yellow-100 text-yellow-800 {% endif %}">
                        {% if order.is_completed %}Completed{% else %}Processing{% endif %}
                    </span>
                    <span class="ml-4 text-lg font-bold text-gray-800">${{ order.total_price }}</span>
                </div>
            </div>
            
            <!-- Order Items -->
            <div class="mt-4">
                <p class="text-sm font-medium text-gray-600 mb-2">Items in this order:</p>
                <div class="space-y-3">
                    {% for item in order.items.all %}
                    <div class="flex items-center space-x-3">
                        <img src="{{ item.book.image.url }}" alt="{{ item.book.title }}" class="w-10 h-12 object-contain border p-1 rounded-md bg-white">
                        <div>
                            <p class="font-semibold text-gray-800">{{ item.book.title }}</p>
                            <p class="text-xs text-gray-500">Qty: {{ item.quantity }} | Price: ${{ item.price }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Shipping Info -->
            <div class="mt-4 border-t pt-3">
                <p class="text-sm font-medium text-gray-600">Shipped to:</p>
                <p class="text-sm text-gray-700 bg-gray-100 p-2 rounded-md mt-1">{{ order.shipping_address }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-20">
        <i class="fas fa-box-open fa-5x text-gray-300"></i>
        <h2 class="mt-6 text-2xl font-semibold text-gray-700">You have no orders yet.</h2>
        <p class="text-gray-500 mt-2">All your future orders will be saved here.</p>
        <a href="{% url 'home' %}" class="mt-8 inline-block bg-blue-500 text-white px-8 py-3 rounded-lg hover:bg-blue-600 transition-colors duration-300 text-base font-semibold">
            <i class="fas fa-store mr-2"></i>
            Start Shopping
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}